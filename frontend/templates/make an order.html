{% extends "base_website.html" %}

{% block title %}Academic Services - تأكيد وطلب الخدمة الفائق{% endblock title %}

{% block body_data_page %}order{% endblock body_data_page %}

{% block extra_head %}
    <style>
        .form-input {
            width: 100%;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 2px solid;
            transition: border-color 0.3s, background-color 0.3s;
            resize: none;
        }
        .dark .form-input {
            background-color: #1A1A1A;
            color: white;
            border-color: rgba(255, 255, 255, 0.1);
        }
        .dark .form-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(184, 134, 11, 0.3);
        }
        .light .form-input {
            background-color: white;
            color: #1A1A1A;
            border-color: #E0E0E0;
        }
        .light .form-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 174, 239, 0.3);
        }
        
        #finalPriceDisplay, #baseCostDisplay, #levelMultiplierDisplay, #urgencyMultiplierDisplay {
            text-shadow: 0 0 3px rgba(255, 255, 255, 0.4); 
        }

        .file-upload-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            border: 2px dashed;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .dark .file-upload-box {
            border-color: rgba(255, 255, 255, 0.3);
            background-color: #1A1A1A;
        }
        .light .file-upload-box {
            border-color: #A0A0A0;
            background-color: #F0F0F0;
        }
        .file-upload-box:hover {
            border-color: var(--primary-color);
        }
        .file-upload-box input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .file-upload-info {
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }


        #progress-bar-container {
            width: 100%;
            height: 10px;
            background-color: rgba(255, 255, 255, 0.1); 
            border-radius: 5px;
            margin-top: 1.5rem;
            overflow: hidden;
            position: relative;
        }

        .light #progress-bar-container {
            background-color: rgba(0, 0, 0, 0.1); 
        }

        #progress-bar {
            height: 100%;
            width: 0%; 
            background-color: var(--primary-color);
            border-radius: 5px;
            transition: width 0.4s ease-in-out;
        }
    </style>
{% endblock extra_head %}

{% block content %}
    <div class="@container relative text-center">
        <div class="relative z-10 p-4">
            <h1 class="dark:text-white light:text-black text-5xl font-black leading-tight tracking-tight md:text-6xl font-display max-w-5xl mx-auto mb-4" style="text-shadow: 0 0 15px var(--glow-color);">
                تأكيد طلبك وبدء التنفيذ.
            </h1>
            <h2 class="dark:text-gray-300 light:text-black text-lg font-normal leading-relaxed md:text-xl max-w-4xl mx-auto">
                أكمل متطلبات مشروعك أدناه. التكلفة التقديرية ستتغير بشكل مباشر مع خياراتك.
            </h2>
            <div id="progress-bar-container" class="mx-auto max-w-2xl">
                <div id="progress-bar"></div>
            </div>
        </div>
    </div>

    <div class="px-4">
        <form id="dynamicOrderForm" class="grid grid-cols-1 lg:grid-cols-3 gap-10 max-w-6xl mx-auto">

            <div class="lg:col-span-2 flex flex-col gap-8 dark:bg-card-dark/70 light:bg-card-light p-8 lg:p-10 rounded-xl shadow-xl border dark:border-white/10 light:border-gray-300">
                
                <h3 class="text-2xl font-black font-display text-primary border-b border-primary/20 pb-3 mb-4">1. تفاصيل الخدمة والوقت</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="flex flex-col gap-2">
                        <label for="service_type" class="dark:text-white light:text-black font-medium">نوع الخدمة المطلوبة</label>
                        <select id="service_type" class="form-input" onchange="updatePrice()" required>
                            <option value="40">بحث تخصصي (40 ر.س/وحدة)</option>
                            <option value="60">مشروع تخرج / أطروحة (60 ر.س/وحدة)</option>
                            <option value="20">واجب / تكليف سريع (20 ر.س/وحدة)</option>
                            <option value="30">برزنتيشن / ملخص (30 ر.س/وحدة)</option>
                            <option value="15">تدقيق لغوي / تنسيق (15 ر.س/وحدة)</option>
                        </select>
                    </div>
                    <div class="flex flex-col gap-2">
                        <label for="academic_level" class="dark:text-white light:text-black font-medium">المستوى الأكاديمي</label>
                        <select id="academic_level" class="form-input" onchange="updatePrice()" required>
                            <option value="1.0">بكالوريوس (1.0x)</option>
                            <option value="1.5">ماجستير (1.5x)</option>
                            <option value="2.0">دكتوراه (2.0x)</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="flex flex-col gap-2">
                        <label for="major" class="dark:text-white light:text-black font-medium">التخصص الدقيق</label>
                        <input type="text" id="major" placeholder="مثال: هندسة الحاسب أو إدارة الموارد البشرية" class="form-input" required>
                    </div>
                    <div class="flex flex-col gap-2">
                        <label for="deadline" class="dark:text-white light:text-black font-medium">الموعد النهائي للتسليم</label>
                        <input type="date" id="deadline" class="form-input" onchange="updatePrice()" required>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="flex flex-col gap-2">
                        <label for="word_count" class="dark:text-white light:text-black font-medium">العدد التقريبي (للكلمات أو الصفحات)</label>
                        <input type="number" id="word_count" placeholder="مثال: 5000" class="form-input" oninput="updatePrice()" required>
                    </div>
                    <div class="flex flex-col gap-2">
                        <label for="unit" class="dark:text-white light:text-black font-medium">وحدة القياس</label>
                        <select id="unit" class="form-input" onchange="updatePrice()">
                            <option value="words">كلمة</option>
                            <option value="pages">صفحة</option>
                        </select>
                    </div>
                </div>
                
                <h3 class="text-2xl font-black font-display text-primary border-b border-primary/20 pb-3 mb-4 mt-6">2. متطلبات العمل وإرفاق الملفات</h3>

                <div class="flex flex-col gap-2">
                    <label for="description" class="dark:text-white light:text-black font-medium">الوصف المفصل لمتطلبات الأستاذ</label>
                    <textarea id="description" placeholder="يرجى إدراج جميع المتطلبات، والمواضيع الأساسية، وأي إرشادات خاصة." rows="6" class="form-input" oninput="updateProgressBar()" required></textarea>
                </div>

                <div class="flex flex-col gap-2">
                    <label class="dark:text-white light:text-black font-medium">إرفاق ملفات (إرشادات/مصادر)</label>
                    <label for="attachments" class="file-upload-box dark:hover:bg-background-dark light:hover:bg-gray-100">
                        <span class="material-symbols-outlined text-primary text-4xl">upload_file</span>
                        <p class="dark:text-gray-400 light:text-gray-600 text-sm font-medium">اسحب وأفلت الملفات هنا، أو اضغط للبحث</p>
                        <p id="file-status" class="dark:text-white light:text-black text-xs mt-1">[ لم يتم اختيار أي ملفات ]</p>
                        <input type="file" id="attachments" multiple onchange="updateFileStatus(this)">
                    </label>
                </div>
                
            </div>

            <div class="lg:col-span-1 flex flex-col gap-6 dark:bg-card-dark light:bg-card-light p-8 rounded-xl shadow-xl border dark:border-primary/20 light:border-secondary-light/20 lg:sticky lg:top-28 lg:h-fit">
                
                <h3 class="text-2xl font-black font-display text-primary border-b border-primary/20 pb-3 mb-4">ملخص الطلب والتكلفة</h3>
                
                <div class="flex flex-col gap-3">
                    <div class="flex justify-between dark:text-gray-300 light:text-gray-700">
                        <span>التكلفة الأساسية (قبل العوامل)</span>
                        <span id="baseCostDisplay" class="font-bold">0.00 ر.س</span>
                    </div>
                    <div class="flex justify-between dark:text-gray-300 light:text-gray-700">
                        <span>عامل المستوى الأكاديمي</span>
                        <span id="levelMultiplierDisplay" class="font-bold dark:text-white/80 light:text-text-dark/80">x 1.0</span>
                    </div>
                    <div class="flex justify-between dark:text-gray-300 light:text-gray-700">
                        <span>عامل التعجيل (الموعد النهائي)</span>
                        <span id="urgencyMultiplierDisplay" class="font-bold text-red-500 dark:text-red-400">x 1.0</span>
                    </div>
                    
                    <div class="h-px dark:bg-white/10 light:bg-gray-300 my-4"></div>
                    
                    <div class="flex justify-between items-center text-3xl font-black font-display">
                        <span class="text-primary">التكلفة التقديرية</span>
                        <span id="finalPriceDisplay" class="text-primary">0.00 ر.س</span>
                    </div>
                    
                </div>
                
                <div class="dark:bg-background-dark light:bg-gray-100 p-4 rounded-lg mt-4 border dark:border-primary/20 light:border-secondary-light/20">
                    <p class="dark:text-gray-400 light:text-gray-600 text-sm italic flex items-center gap-2">
                        <span class="material-symbols-outlined text-green-500">verified</span>
                        **ملاحظة هامة:** سيتم تأكيد هذا السعر من قِبل المنفذ المختص بعد مراجعة الملفات، ولا يتم البدء في العمل إلا بموافقتك.
                    </p>
                </div>
                
                <button type="submit" class="flex min-w-full cursor-pointer items-center justify-center overflow-hidden rounded-xl h-14 px-8 bg-primary dark:text-background-dark light:text-white text-lg font-black leading-normal tracking-[0.015em] shadow-primary-glow hover:shadow-xl transition-shadow duration-500 mt-4">
                    <span class="material-symbols-outlined mr-0">credit_card</span>
                    <span class="whitespace-nowrap">تأكيد الطلب والانتقال للدفع</span> 
                </button>
            </div>
        </form>
    </div>
{% endblock content %}

{% block extra_js %}
    <script>
        function updatePrice() {
            const form = document.getElementById('dynamicOrderForm');
            const serviceType = parseFloat(form.service_type.value || 0);
            const academicLevel = parseFloat(form.academic_level.value || 1.0);
            const wordCount = parseFloat(form.word_count.value || 0);
            const deadlineDate = form.deadline.value;
            const unit = form.unit.value;
            
            updateProgressBar();

            let unitPrice = 0;
            if (unit === 'words') {
                unitPrice = 0.35; 
            } else if (unit === 'pages') {
                unitPrice = 50.00; 
            }

            let urgencyMultiplier = 1.0;
            let urgencyText = 'x 1.0';
            if (deadlineDate) {
                const deadline = new Date(deadlineDate);
                const now = new Date();
                const diffTime = deadline - now;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays <= 3 && diffDays > 0) {
                    urgencyMultiplier = 1.4;
                    urgencyText = 'x 1.4 (عاجل جداً)';
                } else if (diffDays <= 7 && diffDays > 0) {
                    urgencyMultiplier = 1.2;
                    urgencyText = 'x 1.2 (عاجل)';
                }
            }

            const baseCost = (wordCount * unitPrice) + serviceType;

            const finalPrice = baseCost * academicLevel * urgencyMultiplier;
            
            document.getElementById('baseCostDisplay').textContent = `${baseCost.toFixed(2)} ر.س`;
            document.getElementById('levelMultiplierDisplay').textContent = `x ${academicLevel.toFixed(1)}`;
            document.getElementById('urgencyMultiplierDisplay').textContent = urgencyText;
            document.getElementById('finalPriceDisplay').textContent = `${finalPrice.toFixed(2)} ر.س`;
        }
        

        function updateProgressBar() {
            const form = document.getElementById('dynamicOrderForm');
            const fields = ['service_type', 'academic_level', 'major', 'deadline', 'word_count', 'description'];
            let filledCount = 0;
            
            fields.forEach(field => {
                const element = form[field];
                if (element && element.value.trim() !== '' && (element.type !== 'date' || element.value !== '')) {
                    filledCount++;
                }
            });

            const percentage = (filledCount / fields.length) * 100;
            document.getElementById('progress-bar').style.width = `${percentage.toFixed(0)}%`;
        }


        function updateFileStatus(input) {
            const statusElement = document.getElementById('file-status');
            if (input.files.length > 0) {
                statusElement.textContent = `${input.files.length} ملف تم اختياره بنجاح`;
                statusElement.classList.add('text-green-500');
                statusElement.classList.remove('dark:text-white', 'light:text-text-dark');
            } else {
                statusElement.textContent = '[ لم يتم اختيار أي ملفات ]';
                statusElement.classList.remove('text-green-500');
                statusElement.classList.add('dark:text-white', 'light:text-text-dark');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            updatePrice(); 
            updateProgressBar();
            document.getElementById('dynamicOrderForm').addEventListener('input', updatePrice);
        });
    </script>
{% endblock extra_js %}